<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş İnşaat Yönetim Programı v3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #1a5f7a;
            --secondary-color: #159895;
            --background-color: #f4f7f9;
            --card-background: #ffffff;
            --text-color: #34495e;
            --text-light: #fdfdfd;
            --border-color: #e2e8f0;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
        }
        .container {
            max-width: 1600px;
            margin: 20px auto;
            padding: 0 20px;
        }
        header {
            background: var(--card-background);
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        header .title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary-color);
        }
        header h1 {
            margin: 0;
            font-size: 1.7em;
            white-space: nowrap;
        }
        #project-tabs {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 18px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            border-bottom: none;
            background-color: #e9ecef;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab.active {
            background-color: var(--secondary-color);
            color: var(--text-light);
            border-color: var(--secondary-color);
        }
        .tab:hover:not(.active) { background-color: #d8dde2; }
        #add-project-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        }
        nav button {
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        nav button:hover, nav button.active {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        .view { display: none; animation: fadeIn 0.5s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card {
            background: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        @media (min-width: 1200px) {
            .dashboard-grid { grid-template-columns: 1fr 1fr; }
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .summary-card {
            color: var(--text-light);
            padding: 25px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        .summary-card .icon { position: absolute; right: 15px; top: 15px; font-size: 3em; opacity: 0.2; }
        .summary-card h3 { margin: 0 0 10px 0; font-size: 1.1em; }
        .summary-card .amount { font-size: 1.8em; font-weight: bold; }
        .summary-card .sub-amount { font-size: 0.8em; opacity: 0.8; font-weight: normal; margin-top: 5px;}
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        .form-group label { margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input, .form-group select {
            width: 100%; box-sizing: border-box;
            padding: 12px; border: 1px solid var(--border-color);
            border-radius: 6px; font-size: 1em;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(21, 152, 149, 0.2);
        }
        .btn-submit {
            grid-column: 1 / -1; padding: 15px; background-color: var(--success-color);
            color: white; border: none; border-radius: 6px; cursor: pointer;
            font-size: 1.1em; font-weight: bold; margin-top: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .installments-group { display: none; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        thead { background-color: #f8f9fa; }
        th { font-weight: 600; color: var(--primary-color); cursor: pointer; user-select: none; }
        th .sort-indicator { display: inline-block; width: 20px; text-align: center; }
        tbody tr:hover { background-color: #f1f5f9; }
        tr.group-parent { background-color: #e9f5f9; cursor: pointer; font-weight: bold;}
        tr.group-parent .toggle-icon { transition: transform 0.2s; display: inline-block; }
        tr.group-parent.expanded .toggle-icon { transform: rotate(90deg); }
        tr.installment-child { display: none; background-color: #fafcff; }
        
        .status { padding: 5px 12px; border-radius: 99px; font-weight: 500; font-size: 0.85em; }
        .status-paid { background-color: #eafaf1; color: #2ecc71; }
        .status-pending { background-color: #fef9e7; color: #f1c40f; }
        
        .actions-cell { display: flex; gap: 5px; flex-wrap: wrap;}
        .action-btn {
            padding: 6px 10px; border: none; border-radius: 6px; color: white;
            cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-pay { background-color: var(--success-color); }
        .btn-undo { background-color: var(--danger-color); }
        .btn-edit { background-color: var(--info-color); }
        .btn-delete { background-color: #7f8c8d; }
        .btn-export { background-color: var(--info-color); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;}

        #category-stats { background-color: #e7f5ff; border-left: 5px solid var(--primary-color); border-radius: 5px; margin-top: 20px; padding: 15px;}

        /* MODAL & TOAST */
        .modal-overlay {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--card-background); padding: 30px;
            border-radius: 12px; width: 90%; max-width: 500px;
            box-shadow: var(--shadow-lg); animation: slideIn 0.3s;
        }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: var(--primary-color); }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .modal-btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; }
        .btn-confirm { background-color: var(--danger-color); color: white; }
        .btn-cancel { background-color: #ccc; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast {
            background-color: var(--text-color); color: white; padding: 15px 20px;
            border-radius: 8px; box-shadow: var(--shadow-lg);
            margin-bottom: 10px; display: flex; align-items: center; gap: 10px;
            opacity: 0; transform: translateX(100%); animation: slideInToast 0.5s forwards;
        }
        @keyframes slideInToast { to { opacity: 1; transform: translateX(0); } }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div class="container">
        <header id="app-header">
            <div class="title">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256"><path d="M240,216h-8V88a16,16,0,0,0-16-16H168V48a16,16,0,0,0-16-16H48A16,16,0,0,0,32,48V216H24a8,8,0,0,0,0,16H240a8,8,0,0,0,0-16ZM152,88V216H48V48h16V80a8,8,0,0,0,16,0V48h56v40a8,8,0,0,0,16,0ZM112,120v24a8,8,0,0,1-16,0V120a8,8,0,0,1,16,0Zm40,0v24a8,8,0,0,1-16,0V120a8,8,0,0,1,16,0Zm48,96H168V88h48V216Z"></path></svg>
                <h1>Proje Finans Yönetimi</h1>
            </div>
            <div id="project-tabs">
                <!-- Proje sekmeleri buraya gelecek -->
            </div>
        </header>

        <nav>
            <button class="nav-btn" data-view="dashboard-view">📊 Pano</button>
            <button class="nav-btn" data-view="transactions-view">📋 Gelir/Gider Listesi</button>
            <button class="nav-btn" data-view="add-expense-view">💸 Gider Ekle</button>
            <button class="nav-btn" data-view="add-income-view">💰 Gelir Ekle</button>
            <button class="nav-btn" data-view="settings-view">⚙️ Ayarlar</button>
        </nav>

        <main id="content-area">
            <!-- Pano -->
            <div id="dashboard-view" class="view active">
                <div class="card" style="padding-bottom:10px;">
                    <h3>Gelir Özeti</h3>
                    <div class="summary-grid">
                        <div class="summary-card" style="background: var(--info-color);"><div class="icon">💰</div><h3>Toplam Gelir</h3><div class="amount" id="total-income">0 TL</div></div>
                        <div class="summary-card" style="background: var(--success-color);"><div class="icon">✅</div><h3>Alınan Gelir</h3><div class="amount" id="received-income">0 TL</div></div>
                        <div class="summary-card" style="background: var(--warning-color);"><div class="icon">⏳</div><h3>Bekleyen Gelir</h3><div class="amount" id="pending-income">0 TL</div></div>
                    </div>
                </div>
                 <div class="card" style="padding-bottom:10px;">
                    <h3>Gider Özeti</h3>
                    <div class="summary-grid">
                        <div class="summary-card" style="background: #e74c3c;"><div class="icon">💸</div><h3>Toplam Gider</h3><div class="amount" id="total-expense">0 TL</div></div>
                        <div class="summary-card" style="background: #27ae60;"><div class="icon">✔️</div><h3>Ödenen Gider</h3><div class="amount" id="paid-expense">0 TL</div></div>
                        <div class="summary-card" style="background: var(--danger-color);"><div class="icon">⌛</div><h3>Kalan Borç</h3><div class="amount" id="remaining-debt">0 TL</div></div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="card">
                        <h2>Aylık Gelir/Gider Projeksiyonu</h2>
                        <div class="chart-container" style="position: relative; height:280px; width:100%">
                            <canvas id="monthly-flow-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2>Kategoriye Göre Gider Dağılımı</h2>
                        <div class="chart-container" style="position: relative; height:280px; width:100%">
                            <canvas id="category-expense-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gelir/Gider Listesi -->
            <div id="transactions-view" class="view">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
                        <h2>Gelir/Gider Listesi</h2>
                        <button id="export-csv-btn" class="btn-export">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M224,144v64a8,8,0,0,1-8,8H40a8,8,0,0,1-8-8V144a8,8,0,0,1,16,0v56H208V144a8,8,0,0,1,16,0ZM93.66,101.66,120,128V24a8,8,0,0,1,16,0v104l26.34-26.34a8,8,0,0,1,11.32,11.32l-40,40a8,8,0,0,1-11.32,0l-40-40a8,8,0,0,1,11.32-11.32Z"></path></svg>
                            CSV Olarak Dışa Aktar
                        </button>
                    </div>
                     <div id="category-filter-container" style="margin-top:20px; display:flex; gap:10px; align-items:center;">
                        <label for="category-filter" style="font-weight:bold;">Kategoriye Göre Filtrele:</label>
                        <select id="category-filter" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border-color);"></select>
                    </div>
                    <div id="category-stats" style="display:none;"></div>
                    <div style="overflow-x:auto;">
                        <table id="transactions-table">
                            <thead>
                                <tr>
                                    <th data-sort="description">Açıklama <span class="sort-indicator"></span></th>
                                    <th data-sort="amount">Tutar <span class="sort-indicator"></span></th>
                                    <th data-sort="category">Kategori/Kaynak <span class="sort-indicator"></span></th>
                                    <th data-sort="paymentType">Ödeme Türü <span class="sort-indicator"></span></th>
                                    <th data-sort="dueDate">Tarih <span class="sort-indicator"></span></th>
                                    <th data-sort="isPaid">Durum <span class="sort-indicator"></span></th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Form View'ları -->
            <div id="add-expense-view" class="view">
                <div class="card">
                    <h2>Yeni Gider Ekle</h2>
                    <form id="expense-form">
                        <div class="form-grid">
                            <div class="form-group"><label for="exp-description">Açıklama</label><input type="text" id="exp-description" required></div>
                            <div class="form-group"><label for="exp-supplier">Tedarikçi / Firma</label><input type="text" id="exp-supplier"></div>
                            <div class="form-group"><label for="exp-amount">Tutar (TL)</label><input type="number" id="exp-amount" step="0.01" required></div>
                            <div class="form-group"><label for="exp-usd-rate">Dolar Kuru (USD Karşılığı İçin)</label><input type="number" id="exp-usd-rate" step="0.0001" placeholder="Boş bırakılırsa sadece TL"></div>
                            <div class="form-group"><label for="exp-due-date">İlk Vade Tarihi</label><input type="date" id="exp-due-date" required></div>
                            <div class="form-group"><label for="exp-category">Kategori</label><select id="exp-category" required></select></div>
                            <div class="form-group"><label for="exp-payment-type">Ödeme Türü</label><select id="exp-payment-type"><option>Nakit</option><option>Kredi Kartı</option><option>Banka Transferi</option><option>Çek</option></select></div>
                            <div class="form-group installments-group" id="exp-installments-group"><label for="exp-installments">Taksit Sayısı</label><input type="number" id="exp-installments" min="1" value="1"></div>
                        </div>
                        <button type="submit" class="btn-submit">Gideri Kaydet</button>
                    </form>
                </div>
            </div>
            <div id="add-income-view" class="view">
                 <div class="card">
                    <h2>Yeni Gelir Ekle</h2>
                    <form id="income-form">
                        <div class="form-grid">
                             <div class="form-group"><label for="inc-description">Açıklama</label><input type="text" id="inc-description" required></div>
                             <div class="form-group"><label for="inc-source">Gelir Kaynağı (Müşteri vb.)</label><input type="text" id="inc-source"></div>
                             <div class="form-group"><label for="inc-amount">Tutar (TL)</label><input type="number" id="inc-amount" step="0.01" required></div>
                             <div class="form-group"><label for="inc-usd-rate">Dolar Kuru (USD Karşılığı İçin)</label><input type="number" id="inc-usd-rate" step="0.0001" placeholder="Boş bırakılırsa sadece TL"></div>
                             <div class="form-group"><label for="inc-date">İlk Gelir Tarihi</label><input type="date" id="inc-date" required></div>
                             <div class="form-group"><label for="inc-installments">Taksit Sayısı</label><input type="number" id="inc-installments" min="1" value="1"></div>
                        </div>
                        <button type="submit" class="btn-submit">Geliri Kaydet</button>
                    </form>
                </div>
            </div>

            <!-- Ayarlar View -->
            <div id="settings-view" class="view">
                <div class="card">
                    <h2>Veri Yönetimi</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                         <button id="backup-data-btn" class="btn-export" style="background-color: var(--primary-color);">Verileri İndir (Yedekle)</button>
                         <button id="restore-data-btn" class="btn-export" style="background-color: var(--warning-color); color: var(--text-color);">Verileri Yükle (Geri Yükle)</button>
                         <input type="file" id="restore-file-input" style="display: none;" accept=".txt, .json">
                    </div>
                </div>
                 <div class="card">
                    <h2>Kategori Yönetimi</h2>
                    <form id="category-form" style="display:flex; gap:10px; margin-bottom: 20px;">
                        <input type="text" id="new-category" placeholder="Yeni Gider Kategorisi Adı" required style="flex-grow:1; padding:12px; border-radius:6px; border: 1px solid var(--border-color);">
                        <button type="submit" class="action-btn" style="background-color: var(--secondary-color);">Ekle</button>
                    </form>
                    <h3>Mevcut Kategoriler:</h3>
                    <ul id="category-list" style="list-style-type: none; padding: 0;"></ul>
                </div>
                 <div class="card">
                    <h2>Proje Yönetimi</h2>
                    <button id="delete-project-btn" class="action-btn" style="background-color: var(--danger-color);">Aktif Projeyi Sil</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>Gider Ödeme Onayı</h2></div>
            <p>Bu TL ödemesini onaylarken, işlem günündeki Dolar karşılığını kaydetmek için kuru girin.</p>
            <div class="form-group">
                <label for="payment-usd-rate">Ödeme Günü Dolar Kuru (₺)</label>
                <input type="number" id="payment-usd-rate" step="0.01" required placeholder="Örn: 32.85">
                <input type="hidden" id="payment-id-holder">
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel">İptal</button>
                <button id="confirm-payment-btn" class="modal-btn" style="background-color:var(--success-color); color:white;">Ödemeyi Onayla</button>
            </div>
        </div>
    </div>
     <div id="income-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>Gelir Alındı Onayı</h2></div>
            <p>Bu TL gelirini onaylarken, işlem günündeki Dolar karşılığını kaydetmek için kuru girin.</p>
            <div class="form-group">
                <label for="income-usd-rate">Alındığı Gün Dolar Kuru (₺)</label>
                <input type="number" id="income-usd-rate" step="0.01" required placeholder="Örn: 32.90">
                <input type="hidden" id="income-id-holder">
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel">İptal</button>
                <button id="confirm-income-btn" class="modal-btn" style="background-color:var(--success-color); color:white;">Geliri Onayla</button>
            </div>
        </div>
    </div>
    <div id="edit-transaction-modal" class="modal-overlay">
        <div class="modal-content">
             <div class="modal-header"><h2 id="edit-modal-title">Kaydı Düzenle</h2></div>
             <form id="edit-form"></form> <!-- Form content will be injected here -->
             <div class="modal-footer">
                <button class="modal-btn btn-cancel">İptal</button>
                <button id="save-edit-btn" class="modal-btn" style="background-color:var(--success-color); color:white;">Kaydet</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="modal-overlay">
         <div class="modal-content">
            <div class="modal-header"><h2 id="confirm-modal-title">Onay</h2></div>
            <p id="confirm-modal-text">Bu işlemi yapmak istediğinizden emin misiniz?</p>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel">İptal</button>
                <button id="confirm-modal-btn" class="modal-btn btn-confirm">Onayla</button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // UI ELEMENTS
    const navButtons = document.querySelectorAll('.nav-btn');
    const views = document.querySelectorAll('.view');
    // STATE MANAGEMENT
    let state = {};
    const initialState = {
        projects: [{
            id: `proje_${Date.now()}`,
            name: 'Ana Proje',
            expenses: [],
            incomes: [],
            categories: ['Malzeme', 'İşçilik', 'Nakliye', 'Hafriyat', 'Resmi Harçlar']
        }],
        activeProjectId: null
    };
    initialState.activeProjectId = initialState.projects[0].id;
    
    // CHART INSTANCES (are declared globally to be destroyed and recreated)
    let monthlyFlowChart = null;
    let categoryExpenseChart = null;
    
    // SORTING STATE
    let sortState = { column: 'dueDate', direction: 'desc' };

    // --- CORE FUNCTIONS ---
    function loadState() {
        try {
            const savedState = localStorage.getItem('constructionFinanceApp_v3');
            state = savedState ? JSON.parse(savedState) : { ...initialState };
            if (!state.projects || state.projects.length === 0) {
                state.projects = [...initialState.projects];
                state.activeProjectId = state.projects[0]?.id;
            }
            if (!state.activeProjectId || !state.projects.find(p => p.id === state.activeProjectId)) {
                state.activeProjectId = state.projects[0]?.id;
            }
        } catch (e) {
            console.error("Failed to load state:", e);
            state = JSON.parse(JSON.stringify(initialState));
        }
    }

    function saveState() {
        try {
            localStorage.setItem('constructionFinanceApp_v3', JSON.stringify(state));
        } catch(e) {
            console.error("Failed to save state:", e);
            showToast("Veri kaydedilemedi. Tarayıcı depolama alanı dolu olabilir.", "error");
        }
    }

    function getActiveProject() {
        if (!state.activeProjectId) return null;
        return state.projects.find(p => p.id === state.activeProjectId);
    }
    
    // --- RENDER FUNCTIONS ---
    function renderAll() {
        const project = getActiveProject();
        if (!project) {
            document.querySelector('main').innerHTML = '<div class="card">Lütfen bir proje seçin veya yeni bir proje oluşturun.</div>';
            return;
        };
        renderProjectTabs();
        renderDashboard();
        renderTransactionsTable();
        populateCategoryDropdowns();
        renderSettings();
        const activeView = document.querySelector('.view.active')?.id || 'dashboard-view';
        setActiveView(activeView);
    }

    function renderProjectTabs() {
        const projectTabsContainer = document.getElementById('project-tabs');
        projectTabsContainer.innerHTML = '';
        state.projects.forEach(project => {
            const tab = document.createElement('div');
            tab.className = `tab ${project.id === state.activeProjectId ? 'active' : ''}`;
            tab.dataset.projectId = project.id;
            tab.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M208,64H152V56a24,24,0,0,0-24-24H88A24,24,0,0,0,64,56v8H48A24,24,0,0,0,24,88V200a24,24,0,0,0,24,24H208a24,24,0,0,0,24-24V88A24,24,0,0,0,208,64Zm-56,0H112V56a8,8,0,0,1,8-8h16a8,8,0,0,1,8,8ZM216,200a8,8,0,0,1-8,8H48a8,8,0,0,1-8-8V88a8,8,0,0,1,8-8H72v8a16,16,0,0,0,16,16h80a16,16,0,0,0,16-16V80h24a8,8,0,0,1,8,8Z"></path></svg> <span>${project.name}</span>`;
            projectTabsContainer.appendChild(tab);
        });
        const addBtn = document.createElement('button');
        addBtn.id = 'add-project-btn';
        addBtn.title = 'Yeni Proje Ekle';
        addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path></svg><span>Yeni Proje</span>`;
        projectTabsContainer.appendChild(addBtn);
    }

    function renderDashboard() {
        const project = getActiveProject();
        if (!project) return;
        
        // TL Calculations
        const totalIncome = project.incomes.reduce((sum, item) => sum + item.amount, 0);
        const receivedIncome = project.incomes.filter(i => i.isReceived).reduce((sum, item) => sum + item.amount, 0);
        const pendingIncome = totalIncome - receivedIncome;

        const totalExpense = project.expenses.reduce((sum, item) => sum + item.amount, 0);
        const paidExpense = project.expenses.filter(e => e.isPaid).reduce((sum, item) => sum + item.amount, 0);
        const remainingDebt = totalExpense - paidExpense;

        // USD Calculations
        const totalIncomeUsd = project.incomes.filter(i => i.entryRate > 0).reduce((sum, i) => sum + (i.amount / i.entryRate), 0);
        const receivedIncomeUsd = project.incomes.filter(i => i.isReceived && i.receivedRate > 0).reduce((sum, i) => sum + (i.amount / i.receivedRate), 0);
        const pendingIncomeUsd = project.incomes.filter(i => !i.isReceived && i.entryRate > 0).reduce((sum, i) => sum + (i.amount / i.entryRate), 0);

        const totalExpenseUsd = project.expenses.filter(e => e.entryRate > 0).reduce((sum, e) => sum + (e.amount / e.entryRate), 0);
        const paidExpenseUsd = project.expenses.filter(e => e.isPaid && e.paidRate > 0).reduce((sum, e) => sum + (e.amount / e.paidRate), 0);
        const remainingDebtUsd = project.expenses.filter(e => !e.isPaid && e.entryRate > 0).reduce((sum, e) => sum + (e.amount / e.entryRate), 0);
        
        const cashFlow = {};
        const categoryExpenses = {};
        const allMonths = new Set();
        
        project.incomes.forEach(inc => allMonths.add(new Date(inc.date).toLocaleString('tr-TR', { year: 'numeric', month: 'long' })));
        project.expenses.forEach(exp => allMonths.add(new Date(exp.dueDate).toLocaleString('tr-TR', { year: 'numeric', month: 'long' })));

        Array.from(allMonths).sort((a,b) => {
             const [monthA, yearA] = a.split(" ");
             const [monthB, yearB] = b.split(" ");
             const monthIndexA = ['Ocak','Şubat','Mart','Nisan','Mayıs','Haziran','Temmuz','Ağustos','Eylül','Ekim','Kasım','Aralık'].indexOf(monthA);
             const monthIndexB = ['Ocak','Şubat','Mart','Nisan','Mayıs','Haziran','Temmuz','Ağustos','Eylül','Ekim','Kasım','Aralık'].indexOf(monthB);
             return new Date(yearA, monthIndexA) - new Date(yearB, monthIndexB);
        }).forEach(month => {
            cashFlow[month] = { received: 0, pendingIncome: 0, paid: 0, pendingExpense: 0 };
        });
        
        project.incomes.forEach(inc => {
            const month = new Date(inc.date).toLocaleString('tr-TR', { year: 'numeric', month: 'long' });
            if (inc.isReceived) cashFlow[month].received += inc.amount; else cashFlow[month].pendingIncome += inc.amount;
        });

        project.expenses.forEach(exp => {
            const month = new Date(exp.dueDate).toLocaleString('tr-TR', { year: 'numeric', month: 'long' });
            if (exp.isPaid) {
                cashFlow[month].paid += exp.amount;
                const category = exp.category || 'Kategorisiz';
                categoryExpenses[category] = (categoryExpenses[category] || 0) + exp.amount;
            } else {
                 cashFlow[month].pendingExpense += exp.amount;
            }
        });
        
        const updateCard = (elementId, tlValue, usdValue) => {
            document.getElementById(elementId).innerHTML = `
                ${formatCurrency(tlValue)} TL
                <div class="sub-amount">${formatCurrency(usdValue, 'USD')}</div>
            `;
        };

        updateCard('total-income', totalIncome, totalIncomeUsd);
        updateCard('received-income', receivedIncome, receivedIncomeUsd);
        updateCard('pending-income', pendingIncome, pendingIncomeUsd);
        updateCard('total-expense', totalExpense, totalExpenseUsd);
        updateCard('paid-expense', paidExpense, paidExpenseUsd);
        updateCard('remaining-debt', remainingDebt, remainingDebtUsd);
        
        renderMonthlyFlowChart(cashFlow);
        renderCategoryChart(categoryExpenses);
    }
    
    function renderMonthlyFlowChart(data) {
        const canvasId = 'monthly-flow-chart';
        if (Chart.getChart(canvasId)) {
            Chart.getChart(canvasId).destroy();
        }

        const ctx = document.getElementById(canvasId).getContext('2d');
        
        const sortedMonths = Object.keys(data).sort((a,b) => {
             const [monthA, yearA] = a.split(" ");
             const [monthB, yearB] = b.split(" ");
             const monthIndexA = ['Ocak','Şubat','Mart','Nisan','Mayıs','Haziran','Temmuz','Ağustos','Eylül','Ekim','Kasım','Aralık'].indexOf(monthA);
             const monthIndexB = ['Ocak','Şubat','Mart','Nisan','Mayıs','Haziran','Temmuz','Ağustos','Eylül','Ekim','Kasım','Aralık'].indexOf(monthB);
             return new Date(yearA, monthIndexA) - new Date(yearB, monthIndexB);
        });

        const labels = sortedMonths;
        const receivedData = labels.map(month => data[month].received);
        const pendingIncomeData = labels.map(month => data[month].pendingIncome);
        const paidData = labels.map(month => data[month].paid);
        const pendingExpenseData = labels.map(month => data[month].pendingExpense);

        new Chart(ctx, {
            type: 'bar',
            data: { 
                labels, 
                datasets: [
                    {
                        label: 'Alınan Gelir',
                        data: receivedData,
                        backgroundColor: 'rgba(46, 204, 113, 1)',
                        stack: 'Gelir'
                    },
                     {
                        label: 'Beklenen Gelir',
                        data: pendingIncomeData,
                        backgroundColor: 'rgba(46, 204, 113, 0.5)',
                        stack: 'Gelir'
                    },
                    {
                        label: 'Ödenen Gider',
                        data: paidData,
                        backgroundColor: 'rgba(231, 76, 60, 1)',
                        stack: 'Gider'
                    },
                     {
                        label: 'Beklenen Gider',
                        data: pendingExpenseData,
                        backgroundColor: 'rgba(231, 76, 60, 0.5)',
                        stack: 'Gider'
                    }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: false }, y: { stacked: true }} }
        });
    }

    function renderCategoryChart(data) {
        const canvasId = 'category-expense-chart';
        if (Chart.getChart(canvasId)) {
            Chart.getChart(canvasId).destroy();
        }
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Object.keys(data);
        const values = Object.values(data);

        new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{
                label: 'Kategori Giderleri (TL)',
                data: values,
                backgroundColor: ['#159895', '#1a5f7a', '#ff7b54', '#ffb26b', '#ffd56b', '#939b62'],
            }]},
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderTransactionsTable() {
        const project = getActiveProject();
        if (!project) return;

        const tableBody = document.getElementById('transactions-table-body');
        const categoryFilter = document.getElementById('category-filter').value;
        tableBody.innerHTML = '';
        
        let itemsToRender = [
            ...project.expenses.map(e => ({ ...e, type: 'expense' })),
            ...project.incomes.map(i => ({ ...i, type: 'income', dueDate: i.date }))
        ];

        if (categoryFilter !== 'all') {
            itemsToRender = itemsToRender.filter(item => item.type === 'expense' && item.category === categoryFilter);
        }
        updateCategoryStats(categoryFilter);

        itemsToRender.sort((a, b) => {
            let valA = a.dueDate, valB = b.dueDate;
            if (sortState.column && sortState.column !== 'dueDate') {
                 valA = a[sortState.column]; valB = b[sortState.column];
            }
            if (sortState.column === 'amount') {
                valA = a.amount; valB = b.amount;
            }
            let comparison = 0;
            if (valA > valB) comparison = 1; else if (valA < valB) comparison = -1;
            return sortState.direction === 'asc' ? comparison : -comparison;
        });
        
        const groupedItems = itemsToRender.reduce((acc, item) => {
            const key = item.groupId || `single_${item.id}`;
            if (!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {});

        if (Object.keys(groupedItems).length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">Kayıt bulunmuyor.</td></tr>';
        } else {
            for (const key in groupedItems) {
                const items = groupedItems[key];
                if (items[0].groupId) { // It's an installment group
                    const parent = items[0];
                    const totalAmount = items.reduce((sum, i) => sum + i.amount, 0);
                    const parentRow = tableBody.insertRow();
                    parentRow.className = 'group-parent';
                    parentRow.dataset.groupId = parent.groupId;
                    const usdEquivalent = parent.entryRate > 0 ? `($${formatCurrency(totalAmount / parent.entryRate, 'USD', false)})` : '';
                    parentRow.innerHTML = `
                        <td><span class="toggle-icon">▶</span> ${parent.description.replace(/\(\d+\/\d+\)/, '').trim()} (${items.length} Taksit)</td>
                        <td>${formatCurrency(totalAmount)} TL ${usdEquivalent}</td>
                        <td colspan="5"></td>
                    `;
                    items.forEach(item => renderRow(item, tableBody, true));
                } else { // Single item
                    renderRow(items[0], tableBody, false);
                }
            }
        }
        
        document.querySelectorAll('#transactions-table th .sort-indicator').forEach(span => span.textContent = '');
        const activeTh = document.querySelector(`#transactions-table th[data-sort="${sortState.column}"] .sort-indicator`);
        if(activeTh) activeTh.textContent = sortState.direction === 'asc' ? '▲' : '▼';
    }

    function renderRow(item, tableBody, isChild) {
        const row = tableBody.insertRow();
        if (isChild) {
            row.className = `installment-child child-of-${item.groupId}`;
        }

        const actionsCell = document.createElement('td');
        actionsCell.className = 'actions-cell';
        
        const amountDisplay = `${formatCurrency(item.amount)} TL`;
        const usdSubText = item.entryRate > 0 ? `<br><small>($${formatCurrency(item.amount / item.entryRate, 'USD', false)})</small>` : '';

        if (item.type === 'expense') {
            const statusClass = item.isPaid ? 'status-paid' : 'status-pending';
            const statusText = item.isPaid ? 'Ödendi' : 'Bekliyor';
            row.innerHTML = `
                <td>${item.description}</td>
                <td>${amountDisplay}${usdSubText}</td>
                <td>${item.category || ''}</td>
                <td>${item.paymentType || '-'}</td>
                <td>${new Date(item.dueDate).toLocaleDateString('tr-TR')}</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
            `;
            if (!item.isPaid) {
                actionsCell.innerHTML += `<button class="action-btn btn-pay" data-id="${item.id}" title="Öde">Öde</button>`;
            }
            actionsCell.innerHTML += `<button class="action-btn btn-edit" data-id="${item.id}" data-type="expense" title="Düzenle">Düzenle</button>
                                      <button class="action-btn btn-delete" data-id="${item.id}" data-type="expense" title="Sil">Sil</button>`;
        } else { // Income
             const statusClass = item.isReceived ? 'status-paid' : 'status-pending';
             const statusText = item.isReceived ? 'Alındı' : 'Bekleniyor';
             row.innerHTML = `
                <td>${item.description}</td>
                <td>${amountDisplay}${usdSubText}</td>
                <td>Gelir</td>
                <td>-</td>
                <td>${new Date(item.date).toLocaleDateString('tr-TR')}</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
            `;
            if (!item.isReceived) {
                 actionsCell.innerHTML += `<button class="action-btn btn-pay" data-id="${item.id}" data-type="income" title="Alındı Olarak İşaretle">Alındı</button>`;
            }
            actionsCell.innerHTML += `<button class="action-btn btn-edit" data-id="${item.id}" data-type="income" title="Düzenle">Düzenle</button>
                                      <button class="action-btn btn-delete" data-id="${item.id}" data-type="income" title="Sil">Sil</button>`;
        }
        row.appendChild(actionsCell);
    }
    
    function populateCategoryDropdowns() {
        const project = getActiveProject();
        if (!project) return;
        const categorySelects = document.querySelectorAll('select[id*="category"]');
        categorySelects.forEach(select => {
            const currentVal = select.value;
            select.innerHTML = '';
            if(select.id === 'category-filter') select.innerHTML += `<option value="all">Tüm Kategoriler</option>`;
            project.categories.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            if(project.categories.includes(currentVal)) select.value = currentVal;
        });
    }

    function renderSettings() {
        const project = getActiveProject();
        if (!project) return;
        const categoryList = document.getElementById('category-list');
        categoryList.innerHTML = '';
        project.categories.forEach(cat => {
            const li = document.createElement('li');
            li.style = 'padding: 8px; border-bottom: 1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;';
            li.textContent = cat;
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = 'Sil';
            deleteBtn.className = "action-btn btn-delete";
            deleteBtn.onclick = () => {
                 showConfirmModal(`'${cat}' kategorisini silmek istediğinizden emin misiniz?`, () => {
                    project.categories = project.categories.filter(c => c !== cat);
                    saveState();
                    renderAll();
                    showToast("Kategori silindi.", "success");
                });
            };
            li.appendChild(deleteBtn);
            categoryList.appendChild(li);
        });
    }
    
    function updateCategoryStats(category) {
        const project = getActiveProject();
        const statsDiv = document.getElementById('category-stats');
        if (!project || category === 'all') {
            statsDiv.style.display = 'none';
            return;
        }
        const categoryExpenses = project.expenses.filter(e => e.category === category);
        const totalCategoryExpense = categoryExpenses.reduce((sum, e) => sum + e.amount, 0);
        const unpaidCategoryExpense = categoryExpenses.filter(e => !e.isPaid).reduce((sum, e) => sum + e.amount, 0);
        const totalProjectExpense = project.expenses.reduce((sum, e) => sum + e.amount, 0);
        const percentage = totalProjectExpense > 0 ? ((totalCategoryExpense / totalProjectExpense) * 100).toFixed(2) : 0;
        
        statsDiv.innerHTML = `
            <strong>'${category}' Kategorisi Analizi:</strong><br>
            Toplam Gider: <strong>${formatCurrency(totalCategoryExpense)} TL</strong> | 
            Kalan Borç: <strong>${formatCurrency(unpaidCategoryExpense)} TL</strong> | 
            Projedeki Payı: <strong>%${percentage}</strong>
        `;
        statsDiv.style.display = 'block';
    }

    // --- EVENT LISTENERS & HANDLERS ---
    function setupEventListeners() {
        navButtons.forEach(button => button.addEventListener('click', () => setActiveView(button.dataset.view)));

        document.getElementById('app-header').addEventListener('click', (e) => {
            const addBtn = e.target.closest('#add-project-btn');
            const tab = e.target.closest('.tab');
            if (addBtn) handleAddProject();
            if (tab) { state.activeProjectId = tab.dataset.projectId; saveState(); renderAll(); }
        });
        document.getElementById('delete-project-btn').addEventListener('click', handleDeleteProject);

        // Forms
        document.getElementById('expense-form').addEventListener('submit', handleAddExpense);
        document.getElementById('income-form').addEventListener('submit', handleAddIncome);
        document.getElementById('category-form').addEventListener('submit', handleAddCategory);
        document.getElementById('exp-payment-type').addEventListener('change', (e) => {
             document.getElementById('exp-installments-group').style.display = e.target.value === 'Çek' ? 'block' : 'none';
        });

        document.getElementById('category-filter').addEventListener('change', renderTransactionsTable);
        document.getElementById('transactions-table-body').addEventListener('click', handleTableActions);
        document.querySelectorAll('#transactions-table th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                if (sortState.column === column) sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                else { sortState.column = column; sortState.direction = 'desc'; }
                renderTransactionsTable();
            });
        });
        
        // Data backup/restore
        document.getElementById('backup-data-btn').addEventListener('click', handleBackupData);
        document.getElementById('restore-data-btn').addEventListener('click', () => document.getElementById('restore-file-input').click());
        document.getElementById('restore-file-input').addEventListener('change', handleRestoreData);

        // Modals
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('btn-cancel')) {
                    e.currentTarget.style.display = 'none';
                }
            });
        });
        document.getElementById('confirm-payment-btn').addEventListener('click', handleConfirmPayment);
        document.getElementById('confirm-income-btn').addEventListener('click', handleConfirmIncome);
        document.getElementById('save-edit-btn').addEventListener('click', handleSaveEdit);
    }
    
    function handleAddProject() {
        const projectName = prompt('Lütfen yeni projenin adını girin:', `Proje ${state.projects.length + 1}`);
        if(projectName?.trim()) {
            const newProject = {
                id: `proje_${Date.now()}`, name: projectName.trim(),
                expenses: [], incomes: [],
                categories: ['Malzeme', 'İşçilik', 'Nakliye', 'Hafriyat', 'Resmi Harçlar']
            };
            state.projects.push(newProject);
            state.activeProjectId = newProject.id;
            saveState(); renderAll(); showToast("Proje oluşturuldu!", "success");
        }
    }
    
    function handleDeleteProject() {
        const project = getActiveProject();
        if (state.projects.length <= 1) { showToast("Son kalan proje silinemez.", "error"); return; }
        showConfirmModal(`'${project.name}' projesini ve tüm verilerini kalıcı olarak silmek istediğinizden emin misiniz?`, () => {
            state.projects = state.projects.filter(p => p.id !== project.id);
            state.activeProjectId = state.projects[0].id;
            saveState(); renderAll(); showToast("Proje silindi.", "success");
        });
    }

    function handleAddExpense(e) {
        e.preventDefault();
        const project = getActiveProject(); if (!project) return;
        
        const totalAmount = parseFloat(document.getElementById('exp-amount').value);
        const description = document.getElementById('exp-description').value;
        const usdRate = parseFloat(document.getElementById('exp-usd-rate').value);
        const paymentType = document.getElementById('exp-payment-type').value;
        const isCheck = paymentType === 'Çek';
        const installments = isCheck ? parseInt(document.getElementById('exp-installments').value) || 1 : 1;
        const amountPerInstallment = totalAmount / installments;
        const startDateString = document.getElementById('exp-due-date').value;
        const startDate = new Date(startDateString + 'T00:00:00'); // Avoid timezone issues
        const groupId = installments > 1 ? `group_${Date.now()}` : null;
        const today = new Date();
        today.setHours(0,0,0,0);

        for (let i = 0; i < installments; i++) {
            const dueDate = new Date(startDate);
            if (isCheck) dueDate.setMonth(startDate.getMonth() + i);
            
            const isPaid = (paymentType === 'Nakit' || paymentType === 'Kredi Kartı' || paymentType === 'Banka Transferi') && dueDate <= today;

            project.expenses.push({
                id: Date.now() + i,
                groupId: groupId,
                description: installments > 1 ? `${description} (${i+1}/${installments})` : description,
                supplier: document.getElementById('exp-supplier').value,
                amount: amountPerInstallment,
                currency: 'TRY', // Always TRY now
                dueDate: dueDate.toISOString().split('T')[0],
                category: document.getElementById('exp-category').value,
                paymentType: paymentType,
                isPaid: isPaid, 
                paidDate: isPaid ? new Date().toISOString().split('T')[0] : null,
                entryRate: usdRate > 0 ? usdRate : null, 
                paidRate: isPaid && usdRate > 0 ? usdRate : (isPaid ? null : null)
            });
        }
        
        saveState(); e.target.reset(); 
        document.getElementById('exp-installments-group').style.display = 'none';
        showToast(`${installments} adet gider başarıyla eklendi!`, 'success'); 
        renderAll(); setActiveView('transactions-view');
    }

    function handleAddIncome(e) {
        e.preventDefault();
        const project = getActiveProject(); if(!project) return;

        const totalAmount = parseFloat(document.getElementById('inc-amount').value);
        const description = document.getElementById('inc-description').value;
        const usdRate = parseFloat(document.getElementById('inc-usd-rate').value);
        const installments = parseInt(document.getElementById('inc-installments').value) || 1;
        const amountPerInstallment = totalAmount / installments;
        const startDateString = document.getElementById('inc-date').value;
        const startDate = new Date(startDateString + 'T00:00:00');
        const groupId = installments > 1 ? `group_${Date.now()}` : null;
        const today = new Date();
        today.setHours(0,0,0,0);

        for(let i=0; i < installments; i++) {
            const incomeDate = new Date(startDate);
            incomeDate.setMonth(startDate.getMonth() + i);

            project.incomes.push({
                id: Date.now() + i,
                groupId: groupId,
                description: installments > 1 ? `${description} (${i+1}/${installments})` : description,
                source: document.getElementById('inc-source').value,
                amount: amountPerInstallment,
                currency: 'TRY',
                entryRate: usdRate > 0 ? usdRate : null,
                date: incomeDate.toISOString().split('T')[0],
                isReceived: incomeDate <= today,
                receivedRate: incomeDate <= today && usdRate > 0 ? usdRate : null
            });
        }
        
        saveState(); e.target.reset();
        showToast(`${installments} adet gelir başarıyla eklendi!`, 'success'); 
        renderAll(); setActiveView('transactions-view');
    }

    function handleAddCategory(e) {
        e.preventDefault();
        const project = getActiveProject();
        const input = document.getElementById('new-category');
        const name = input.value.trim();
        if (name && !project.categories.find(c => c.toLowerCase() === name.toLowerCase())) {
            project.categories.push(name);
            saveState(); renderAll(); input.value = ''; showToast("Kategori eklendi.", "success");
        } else {
            showToast("Geçersiz veya zaten var olan kategori adı.", "error");
        }
    }

    function handleTableActions(e) {
        const target = e.target;
        const parentRow = target.closest('.group-parent');

        if(parentRow) {
            const groupId = parentRow.dataset.groupId;
            parentRow.classList.toggle('expanded');
            document.querySelectorAll(`.child-of-${groupId}`).forEach(child => {
                child.style.display = child.style.display === 'table-row' ? 'none' : 'table-row';
            });
            return;
        }

        const actionBtn = target.closest('.action-btn');
        if (!actionBtn) return;

        const id = parseInt(actionBtn.dataset.id);
        const type = actionBtn.dataset.type;
        const project = getActiveProject();

        if (actionBtn.classList.contains('btn-delete')) {
            showConfirmModal('Bu kaydı silmek istediğinizden emin misiniz?', () => {
                if (type === 'expense') project.expenses = project.expenses.filter(item => item.id !== id);
                else project.incomes = project.incomes.filter(item => item.id !== id);
                saveState(); renderAll(); showToast("Kayıt silindi.", "success");
            });
        } else if (actionBtn.classList.contains('btn-edit')) {
            openEditModal(id, type);
        } else if (actionBtn.classList.contains('btn-pay')) {
             if (type === 'income') {
                document.getElementById('income-id-holder').value = id;
                document.getElementById('income-modal').style.display = 'flex';
                document.getElementById('income-usd-rate').focus();
             } else {
                document.getElementById('payment-id-holder').value = id;
                document.getElementById('payment-modal').style.display = 'flex';
                document.getElementById('payment-usd-rate').focus();
             }
        }
    }
    
    function openEditModal(id, type) {
        const project = getActiveProject();
        const item = type === 'expense' 
            ? project.expenses.find(i => i.id === id) 
            : project.incomes.find(i => i.id === id);
        if (!item) return;

        const form = document.getElementById('edit-form');
        let formHTML = `<input type="hidden" id="edit-id" value="${id}"><input type="hidden" id="edit-type" value="${type}">`;
        
        if (type === 'expense') {
            document.getElementById('edit-modal-title').textContent = 'Gideri Düzenle';
            formHTML += `
                <div class="form-grid">
                    <div class="form-group"><label>Açıklama</label><input type="text" id="edit-description" value="${item.description}"></div>
                    <div class="form-group"><label>Tedarikçi</label><input type="text" id="edit-supplier" value="${item.supplier || ''}"></div>
                    <div class="form-group"><label>Tutar (TL)</label><input type="number" id="edit-amount" value="${item.amount}"></div>
                    <div class="form-group"><label>Dolar Kuru (Giriş)</label><input type="number" step="0.0001" id="edit-usd-rate" value="${item.entryRate || ''}" placeholder="USD karşılığı için"></div>
                    <div class="form-group"><label>Vade Tarihi</label><input type="date" id="edit-due-date" value="${item.dueDate}"></div>
                    <div class="form-group"><label>Kategori</label><select id="edit-category">${project.categories.map(c => `<option value="${c}" ${c === item.category ? 'selected':''}>${c}</option>`).join('')}</select></div>
                    <div class="form-group"><label>Ödeme Türü</label><select id="edit-payment-type">${['Nakit','Kredi Kartı','Banka Transferi','Çek'].map(t => `<option value="${t}" ${t === item.paymentType ? 'selected':''}>${t}</option>`).join('')}</select></div>
                </div>`;
        } else { // Income
            document.getElementById('edit-modal-title').textContent = 'Geliri Düzenle';
            formHTML += `
                <div class="form-grid">
                    <div class="form-group"><label>Açıklama</label><input type="text" id="edit-description" value="${item.description}"></div>
                    <div class="form-group"><label>Kaynak</label><input type="text" id="edit-source" value="${item.source || ''}"></div>
                    <div class="form-group"><label>Tutar (TL)</label><input type="number" id="edit-amount" value="${item.amount}"></div>
                    <div class="form-group"><label>Dolar Kuru (Giriş)</label><input type="number" step="0.0001" id="edit-usd-rate" value="${item.entryRate || ''}" placeholder="USD karşılığı için"></div>
                    <div class="form-group"><label>Gelir Tarihi</label><input type="date" id="edit-date" value="${item.date}"></div>
                </div>`;
        }
        form.innerHTML = formHTML;
        document.getElementById('edit-transaction-modal').style.display = 'flex';
    }

    function handleSaveEdit() {
        const project = getActiveProject();
        const id = parseInt(document.getElementById('edit-id').value);
        const type = document.getElementById('edit-type').value;

        if (type === 'expense') {
            const expense = project.expenses.find(i => i.id === id);
            const usdRate = parseFloat(document.getElementById('edit-usd-rate').value);
            expense.description = document.getElementById('edit-description').value;
            expense.supplier = document.getElementById('edit-supplier').value;
            expense.amount = parseFloat(document.getElementById('edit-amount').value);
            expense.entryRate = usdRate > 0 ? usdRate : null;
            expense.dueDate = document.getElementById('edit-due-date').value;
            expense.category = document.getElementById('edit-category').value;
            expense.paymentType = document.getElementById('edit-payment-type').value;
        } else { // Income
            const income = project.incomes.find(i => i.id === id);
            const usdRate = parseFloat(document.getElementById('edit-usd-rate').value);
            income.description = document.getElementById('edit-description').value;
            income.source = document.getElementById('edit-source').value;
            income.amount = parseFloat(document.getElementById('edit-amount').value);
            income.entryRate = usdRate > 0 ? usdRate : null;
            income.date = document.getElementById('edit-date').value;
        }
        saveState();
        renderAll();
        document.getElementById('edit-transaction-modal').style.display = 'none';
        showToast("Kayıt güncellendi!", "success");
    }

    function handleConfirmPayment() {
        const id = parseInt(document.getElementById('payment-id-holder').value);
        const rateInput = document.getElementById('payment-usd-rate');
        const paidRate = parseFloat(rateInput.value);

        if (!paidRate || paidRate <= 0) { showToast('Lütfen geçerli bir Dolar kuru girin.', 'error'); return; }
        
        const expense = getActiveProject().expenses.find(exp => exp.id === id);
        expense.isPaid = true; expense.paidDate = new Date().toISOString().split('T')[0];
        expense.paidRate = paidRate;
        saveState();
        document.getElementById('payment-modal').style.display = 'none';
        rateInput.value = ''; renderAll(); showToast("Ödeme onaylandı.", "success");
    }

    function handleConfirmIncome() {
        const id = parseInt(document.getElementById('income-id-holder').value);
        const rateInput = document.getElementById('income-usd-rate');
        const receivedRate = parseFloat(rateInput.value);

        if (!receivedRate || receivedRate <= 0) { showToast('Lütfen geçerli bir Dolar kuru girin.', 'error'); return; }
        
        const income = getActiveProject().incomes.find(inc => inc.id === id);
        income.isReceived = true; 
        income.receivedRate = receivedRate;
        saveState();
        document.getElementById('income-modal').style.display = 'none';
        rateInput.value = ''; renderAll(); showToast("Gelir onaylandı.", "success");
    }

    function handleBackupData() {
        try {
            const data = localStorage.getItem('constructionFinanceApp_v3');
            if(!data) {
                showToast("Yedeklenecek veri bulunamadı.", "error");
                return;
            }
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `proje_yonetim_yedek_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Veriler başarıyla indirildi.", "success");
        } catch (e) {
            showToast("Veri yedeklenirken bir hata oluştu.", "error");
            console.error("Backup failed:", e);
        }
    }

    function handleRestoreData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                // Basic validation to check if the data is what we expect
                if (data && data.projects && Array.isArray(data.projects)) {
                    showConfirmModal("Mevcut tüm veriler bu yedekle değiştirilecek. Emin misiniz?", () => {
                        localStorage.setItem('constructionFinanceApp_v3', JSON.stringify(data));
                        showToast("Veriler başarıyla geri yüklendi! Sayfa yenileniyor...", "success");
                        setTimeout(() => location.reload(), 1500);
                    });
                } else {
                    showToast("Geçersiz yedek dosyası.", "error");
                }
            } catch (err) {
                showToast("Yedek dosyası okunamadı veya bozuk.", "error");
                console.error("Restore failed:", err);
            }
        };
        reader.readAsText(file);
        event.target.value = null; // Reset input for same-file uploads
    }
    
    // --- UI HELPERS ---
    function setActiveView(viewId) {
        views.forEach(view => view.classList.remove('active'));
        document.getElementById(viewId)?.classList.add('active');
        navButtons.forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.nav-btn[data-view="${viewId}"]`)?.classList.add('active');
    }

    function formatCurrency(num, currency = 'TRY', useSymbol = true) {
        if (typeof num !== 'number') return currency === 'USD' ? '$0.00' : '0,00';
        const options = { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        };
        if(useSymbol) {
            options.style = 'currency';
            options.currency = currency;
        }
        return num.toLocaleString(currency === 'USD' ? 'en-US' : 'tr-TR', options);
    }
    
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3500);
    }

    function showConfirmModal(text, onConfirm) {
        const modal = document.getElementById('confirm-modal');
        document.getElementById('confirm-modal-text').textContent = text;
        modal.style.display = 'flex';
        
        const confirmBtn = document.getElementById('confirm-modal-btn');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        newConfirmBtn.onclick = () => { onConfirm(); modal.style.display = 'none'; };
    }
    
    // --- INITIALIZATION ---
    loadState();
    renderAll();
    setupEventListeners();
});
</script>

</body>
</html>
