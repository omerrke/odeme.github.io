<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çoklu Proje Finans Takip Programı</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #1abc9c;
            --text-color: #34495e;
            --bg-color: #ecf0f1;
            --container-bg: #ffffff;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --info-color: #3498db;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: var(--container-bg);
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 1em;
        }
        
        .summary-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 2em;
        }

        .summary-card {
            background: var(--container-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #ddd;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .summary-card:hover { transform: translateY(-5px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .summary-card h2 { margin-top: 0; font-size: 1.1em; color: var(--text-color); border-bottom: none; }
        .summary-card p { font-size: 2em; font-weight: 600; margin: 0; color: var(--primary-color); }
        .summary-card .usd-summary { font-size: 1.1em; color: #7f8c8d; font-weight: 400; margin-top: 5px; }
        .summary-card.paid p { color: var(--success-color); }
        .summary-card.pending p { color: var(--warning-color); }

        .btn {
            display: inline-block; padding: 10px 20px; color: white;
            text-decoration: none; border-radius: 8px; border: none; cursor: pointer; font-size: 1em;
            font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn.primary { background-color: var(--primary-color); }
        .btn.primary:hover { background-color: #1a2531; }
        .btn.secondary { background-color: var(--info-color); }
        .btn.secondary:hover { background-color: #2779b1; }
        .btn.danger { background-color: var(--danger-color); }
        .btn.danger:hover { background-color: #c0392b; }
        .btn.success { background-color: var(--success-color); }
        .btn.success:hover { background-color: #27ae60; }
        .btn.warning { background-color: var(--warning-color); }
        .btn.warning:hover { background-color: #d48a0f; }
        .btn-icon {
            padding: 8px; line-height: 1; font-size: 1.2em;
        }
        .btn-small { font-size: 0.8em; padding: 5px 10px;}

        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; text-align: left; vertical-align: middle;}
        thead { background-color: var(--primary-color); color: white; }
        tbody tr:nth-child(even) { background-color: #f8f9f9; }
        tbody tr:hover { background-color: #f1f1f1; }
        
        .status { padding: 5px 10px; border-radius: 15px; font-weight: 500; text-align: center; font-size: 0.85em; color: white; }
        .status-paid { background-color: var(--success-color); }
        .status-pending { background-color: var(--warning-color); }
        
        .collapsible { cursor: pointer; }
        .collapsible .arrow { display: inline-block; transition: transform 0.3s; margin-right: 5px; }
        .collapsible.open .arrow { transform: rotate(90deg); }
        .installment-row { display: none; background-color: #fafafa; }
        .installment-row.show { display: table-row; }
        .installment-row td:first-child { padding-left: 40px; }
        .description-cell { font-style: italic; color: #7f8c8d; font-size: 0.9em; max-width: 250px; white-space: pre-wrap; word-wrap: break-word; }

        form { display: flex; flex-direction: column; gap: 1.5em; }
        .form-group { display: flex; flex-direction: column; }
        .form-row { display: flex; gap: 20px; align-items: flex-end; }
        label { margin-bottom: 8px; font-weight: 500; }
        input, select, textarea {
            padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; width: 100%;
            box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s;
        }
        textarea { resize: vertical; min-height: 80px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1); }
        .kur-input-inline {
            width: 70px; padding: 5px; margin-right: 5px; text-align: center;
        }
        .kur-input-inline.invalid {
            border: 2px solid var(--danger-color);
        }
        
        .main-controls { margin-bottom: 2em; display: flex; gap: 10px; flex-wrap: wrap; }

        .filter-container {
            padding: 15px; background-color: #eef3f8; border-radius: 8px; margin-top: 1em;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; align-items: end;
        }
        .project-management {
            display: flex;
            gap: 10px;
            align-items: end;
            border-bottom: 2px solid #bdc3c7;
            padding-bottom: 1em;
            margin-bottom: 1em;
        }
        
        .actions-cell {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 5px;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="anaSayfa" class="container">
        <div class="project-management">
            <div class="form-group" style="flex-grow: 1;">
                <label for="projectSelector">Aktif Proje:</label>
                <select id="projectSelector"></select>
            </div>
            <button id="addProjectBtn" class="btn success btn-icon" title="Yeni Proje Ekle">+</button>
            <button id="deleteProjectBtn" class="btn danger btn-icon" title="Mevcut Projeyi Sil">Sil</button>
        </div>
        
        <h1>Finansal Takip Paneli</h1>

        <div class="summary-container">
            <div class="summary-card">
                <h2>Toplam Borç</h2>
                <p id="toplamGenelTutar">0.00 ₺</p>
                <p class="usd-summary" id="toplamGenelTutarUsd">- $</p>
            </div>
            <div class="summary-card paid">
                <h2>Ödenmiş Tutar</h2>
                <p id="odenenTutar">0.00 ₺</p>
                <p class="usd-summary" id="odenenTutarUsd">- $</p>
            </div>
            <div class="summary-card pending">
                <h2>Bekleyen Tutar</h2>
                <p id="bekleyenTutar">0.00 ₺</p>
                 <p class="usd-summary" id="bekleyenTutarUsd">- $</p>
            </div>
        </div>
        
        <div class="main-controls">
            <button id="yeniOdemeBtn" class="btn primary">Yeni Ödeme Ekle</button>
            <button id="exportBtn" class="btn secondary">Excel'e Aktar</button>
            <button id="backupBtn" class="btn warning">Veriyi Yedekle</button>
        </div>


        <div class="filter-container">
             <div class="form-group">
                <label for="kategoriFiltre">Kategoriye Göre Filtrele:</label>
                <select id="kategoriFiltre"></select>
            </div>
            <div>
                <strong>Filtre Toplamı:</strong>
                <p id="kategoriToplamTutar" style="font-size: 1.5em; font-weight: 600; margin: 0;">0.00 ₺</p>
            </div>
             <button id="gelecekOdemelerBtn" class="btn secondary">Vadesi Gelmemiş Ödemeler</button>
        </div>


        <h2 id="listeBaslik">Tüm Ödemeler</h2>
        <div style="overflow-x:auto;">
             <table>
                <thead>
                    <tr>
                        <th>Başlık</th>
                        <th>Kategori</th>
                        <th>Açıklama</th>
                        <th>Vade</th>
                        <th>Tutar (TRY)</th>
                        <th>Tutar (USD)</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="odemeTablosuBody"></tbody>
            </table>
        </div>
    </div>

    <div id="formSayfasi" class="container hidden">
        <h1>Yeni Ödeme Ekle</h1>
        <form id="odemeFormu">
             <div class="form-group">
                <label for="baslik">Ödeme Başlığı:</label>
                <input type="text" id="baslik" placeholder="Örn: Ofis Kirası" required>
            </div>
            
            <div class="form-group">
                <label for="kategori">Kategori:</label>
                <div class="form-row">
                    <select id="kategori" required style="flex-grow: 1;"></select>
                    <input type="text" id="yeniKategoriInput" placeholder="Yeni kategori ekle" style="flex-grow: 1;">
                    <button type="button" id="yeniKategoriBtn" class="btn secondary">Ekle</button>
                </div>
            </div>

            <div class="form-group">
                <label for="aciklama">Açıklama:</label>
                <textarea id="aciklama" placeholder="Ödeme ile ilgili notlar..."></textarea>
            </div>

            <div class="form-group">
                <label for="tarih">İlk Ödeme Tarihi:</label>
                <input type="date" id="tarih" required>
            </div>

            <div class="form-group">
                <label for="miktar">Toplam Miktar (₺):</label>
                <input type="number" id="miktar" placeholder="Örn: 5000" min="0" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="odemeTuru">Ödeme Türü:</label>
                <select id="odemeTuru">
                    <option value="nakit">Nakit (Tek Seferlik)</option>
                    <option value="vadeli">Vadeli (Taksitli)</option>
                </select>
            </div>
            
            <div id="dolarKuruAlani" class="form-group">
                 <label for="dolarKuruInput">Dolar Kuru (₺)</label>
                 <input type="number" id="dolarKuruInput" placeholder="Örn: 32.54" step="0.01">
            </div>

            <div id="taksitAlani" class="form-group hidden">
                <label for="taksitSayisi">Taksit Sayısı:</label>
                <input type="number" id="taksitSayisi" min="2" placeholder="En az 2">
            </div>

            <div>
                <button type="submit" class="btn primary">Kaydet</button>
                <button type="button" id="iptalBtn" class="btn secondary">İptal</button>
            </div>
        </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const anaSayfa = document.getElementById('anaSayfa');
        const formSayfasi = document.getElementById('formSayfasi');
        const yeniOdemeBtn = document.getElementById('yeniOdemeBtn');
        const iptalBtn = document.getElementById('iptalBtn');
        const odemeFormu = document.getElementById('odemeFormu');
        const odemeTuruSelect = document.getElementById('odemeTuru');
        const taksitAlani = document.getElementById('taksitAlani');
        const odemeTablosuBody = document.getElementById('odemeTablosuBody');
        const yeniKategoriBtn = document.getElementById('yeniKategoriBtn');
        const kategoriFiltre = document.getElementById('kategoriFiltre');
        const gelecekOdemelerBtn = document.getElementById('gelecekOdemelerBtn');
        const listeBaslik = document.getElementById('listeBaslik');
        const dolarKuruAlani = document.getElementById('dolarKuruAlani');
        
        const projectSelector = document.getElementById('projectSelector');
        const addProjectBtn = document.getElementById('addProjectBtn');
        const deleteProjectBtn = document.getElementById('deleteProjectBtn');
        const exportBtn = document.getElementById('exportBtn');
        const backupBtn = document.getElementById('backupBtn');
        
        let currentView = 'all';
        const APP_DATA_KEY = 'paymentAppData_v14';

        // --- PROJE YÖNETİMİ SİSTEMİ (STABLE) ---
        const getAppData = () => {
            const defaultData = {
                activeProjectId: 1,
                projects: [
                    { 
                        id: 1, 
                        name: "Varsayılan Proje",
                        payments: [], 
                        categories: ['İş Makinesi', 'Dış Cephe İşleri', 'Personel Maaşları', 'Malzeme Alımı', 'Faturalar', 'Diğer'] 
                    }
                ]
            };
            const appDataString = localStorage.getItem(APP_DATA_KEY);
            if (appDataString) {
                return JSON.parse(appDataString);
            }
            saveAppData(defaultData); 
            return defaultData;
        };
        const saveAppData = (data) => localStorage.setItem(APP_DATA_KEY, JSON.stringify(data));
        
        const getActiveProject = () => {
            const appData = getAppData();
            return appData.projects.find(p => p.id === appData.activeProjectId) || appData.projects[0];
        };

        const getOdemeler = () => getActiveProject()?.payments || [];
        const saveOdemeler = (odemeler) => {
            const appData = getAppData();
            const project = appData.projects.find(p => p.id === getActiveProject().id);
            if (project) {
                project.payments = odemeler;
                saveAppData(appData);
            }
        };

        const getKategoriler = () => getActiveProject()?.categories || [];
        const saveKategoriler = (kategoriler) => {
            const appData = getAppData();
            const project = appData.projects.find(p => p.id === getActiveProject().id);
            if (project) {
                project.categories = kategoriler;
                saveAppData(appData);
            }
        };
        // --- PROJE YÖNETİMİ SONU ---

        const showPage = (pageToShow) => {
            anaSayfa.classList.toggle('hidden', pageToShow !== 'ana');
            formSayfasi.classList.toggle('hidden', pageToShow !== 'form');
            if (pageToShow === 'ana') {
                renderAll();
            } else if (pageToShow === 'form') {
                odemeTuruSelect.dispatchEvent(new Event('change'));
            }
        };

        const renderKategoriler = () => {
            const kategoriler = getKategoriler();
            const kategoriSelect = document.getElementById('kategori');
            kategoriSelect.innerHTML = '';
            kategoriFiltre.innerHTML = '<option value="Tümü">Tüm Kategoriler</option>';
            kategoriler.forEach(kategori => {
                const optionHTML = `<option value="${kategori}">${kategori}</option>`;
                kategoriSelect.innerHTML += optionHTML;
                kategoriFiltre.innerHTML += optionHTML;
            });
        };
        
        const renderProjectSelector = () => {
            const appData = getAppData();
            projectSelector.innerHTML = '';
            appData.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                if(project.id === appData.activeProjectId) {
                    option.selected = true;
                }
                projectSelector.appendChild(option);
            });
             deleteProjectBtn.classList.toggle('hidden', appData.projects.length <= 1);
        };

        const addNewCategory = () => {
            const yeniKategoriInput = document.getElementById('yeniKategoriInput');
            const yeniKategori = yeniKategoriInput.value.trim();
            if (yeniKategori) {
                const kategoriler = getKategoriler();
                if (!kategoriler.includes(yeniKategori)) {
                    kategoriler.push(yeniKategori);
                    saveKategoriler(kategoriler);
                    renderKategoriler();
                    document.getElementById('kategori').value = yeniKategori;
                }
                yeniKategoriInput.value = '';
            }
        };

        const renderHomePage = () => {
            let allOdemeler = getOdemeler();
            let odemelerToDisplay = allOdemeler;

            if (currentView === 'future') {
                odemelerToDisplay = allOdemeler.filter(o => !o.odendi);
                listeBaslik.textContent = "Vadesi Gelmemiş Ödemeler";
                gelecekOdemelerBtn.textContent = 'Tüm Ödemeleri Göster';
                gelecekOdemelerBtn.classList.replace('secondary', 'primary');
            } else {
                const seciliKategori = kategoriFiltre.value;
                if (seciliKategori !== 'Tümü') {
                    odemelerToDisplay = allOdemeler.filter(o => o.kategori === seciliKategori);
                }
                listeBaslik.textContent = seciliKategori === 'Tümü' ? "Tüm Ödemeler" : `${seciliKategori} Kategorisi`;
                gelecekOdemelerBtn.textContent = 'Vadesi Gelmemiş Ödemeler';
                gelecekOdemelerBtn.classList.replace('primary', 'secondary');
            }

            odemeTablosuBody.innerHTML = '';

            let toplamGenel = 0, odenenTutar = 0, bekleyenTutar = 0, filtreToplami = 0, odenenTutarUsd = 0;
            
            allOdemeler.forEach(odeme => {
                toplamGenel += odeme.tutar;
                if (odeme.odendi) {
                    odenenTutar += odeme.tutar;
                    if(odeme.odemeKuru) {
                        odenenTutarUsd += odeme.tutar / odeme.odemeKuru;
                    }
                } else {
                    bekleyenTutar += odeme.tutar;
                }
            });
            odemelerToDisplay.forEach(o => filtreToplami += o.tutar);

            const gruplanmisOdemeler = odemelerToDisplay.reduce((acc, odeme) => {
                const key = odeme.groupID || odeme.id;
                if (!acc[key]) acc[key] = [];
                acc[key].push(odeme);
                return acc;
            }, {});
            
            if (odemelerToDisplay.length === 0) {
                 odemeTablosuBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Gösterilecek ödeme bulunmuyor.</td></tr>`;
            }

            Object.values(gruplanmisOdemeler).sort((a,b) => new Date(a[0].vadeTarihi) - new Date(b[0].vadeTarihi)).forEach(grup => {
                const parent = grup[0];
                if (grup.length > 1) {
                    const toplamTaksitTutari = grup.reduce((sum, item) => sum + item.tutar, 0);
                    const row = document.createElement('tr');
                    row.className = 'collapsible'; row.dataset.groupId = parent.groupID;
                    row.innerHTML = `
                        <td><span class="arrow">▶</span> ${parent.parentBaslik} (${grup.length} Taksit)</td>
                        <td>${parent.kategori}</td> <td class="description-cell">${parent.aciklama || '-'}</td>
                        <td>${new Date(parent.vadeTarihi).toLocaleDateString('tr-TR')} ...</td>
                        <td>${toplamTaksitTutari.toFixed(2)} ₺</td> <td>-</td>
                        <td>-</td>
                        <td class="actions-cell"><button class="btn danger btn-small" data-delete-group="${parent.groupID}">Grubu Sil</button></td>`;
                    odemeTablosuBody.appendChild(row);
                    
                    grup.forEach(odeme => {
                        const durum = odeme.odendi ? 'Ödendi' : 'Bekliyor';
                        const durumClass = odeme.odendi ? 'status-paid' : 'status-pending';
                        const usdAmountText = odeme.odendi && odeme.odemeKuru ? `${(odeme.tutar / odeme.odemeKuru).toFixed(2)} $` : '-';
                        const installmentRow = document.createElement('tr');
                        installmentRow.className = 'installment-row'; installmentRow.dataset.groupId = odeme.groupID;
                        installmentRow.innerHTML = `
                            <td style="color: #555;">${odeme.baslik}</td> <td></td> <td></td>
                            <td>${new Date(odeme.vadeTarihi).toLocaleDateString('tr-TR')}</td>
                            <td>${odeme.tutar.toFixed(2)} ₺</td>
                            <td>${usdAmountText}</td>
                            <td><span class="status ${durumClass}">${durum}</span></td>
                            <td class="actions-cell">
                                ${!odeme.odendi ? `
                                <input type="number" class="kur-input-inline" placeholder="Kur" data-kur-id="${odeme.id}" step="0.01">
                                <button class="btn success btn-small" data-mark-paid-id="${odeme.id}">Onayla</button>
                                ` : ''}
                                <button class="btn danger btn-small" data-delete-id="${odeme.id}">Sil</button>
                            </td>`;
                        odemeTablosuBody.appendChild(installmentRow);
                    });
                } else {
                    const odeme = grup[0];
                    const durum = odeme.odendi ? 'Ödendi' : 'Bekliyor';
                    const durumClass = odeme.odendi ? 'status-paid' : 'status-pending';
                    const usdAmountText = odeme.odendi && odeme.odemeKuru ? `${(odeme.tutar / odeme.odemeKuru).toFixed(2)} $` : '-';
                    odemeTablosuBody.innerHTML += `
                        <tr>
                            <td>${odeme.baslik}</td> <td>${odeme.kategori}</td>
                            <td class="description-cell">${odeme.aciklama || '-'}</td>
                            <td>${new Date(odeme.vadeTarihi).toLocaleDateString('tr-TR')}</td>
                            <td>${odeme.tutar.toFixed(2)} ₺</td>
                            <td>${usdAmountText}</td>
                            <td><span class="status ${durumClass}">${durum}</span></td>
                            <td class="actions-cell">
                                ${!odeme.odendi ? `
                                <input type="number" class="kur-input-inline" placeholder="Kur" data-kur-id="${odeme.id}" step="0.01">
                                <button class="btn success btn-small" data-mark-paid-id="${odeme.id}">Onayla</button>
                                ` : ''}
                                <button class="btn danger btn-small" data-delete-id="${odeme.id}">Sil</button>
                            </td>
                        </tr>`;
                }
            });
            
            document.getElementById('toplamGenelTutar').textContent = `${toplamGenel.toFixed(2)} ₺`;
            document.getElementById('odenenTutar').textContent = `${odenenTutar.toFixed(2)} ₺`;
            document.getElementById('bekleyenTutar').textContent = `${bekleyenTutar.toFixed(2)} ₺`;
            document.getElementById('kategoriToplamTutar').textContent = `${filtreToplami.toFixed(2)} ₺`;
            
            document.getElementById('odenenTutarUsd').textContent = `${odenenTutarUsd.toFixed(2)} $`;
            document.getElementById('toplamGenelTutarUsd').textContent = `${odenenTutarUsd.toFixed(2)} $`;
            document.getElementById('bekleyenTutarUsd').textContent = `- $`;
        };
        
        const renderAll = () => {
            renderProjectSelector();
            renderKategoriler();
            renderHomePage();
        };
        
        const handleFormSubmit = (e) => {
            e.preventDefault();
            const baslik = document.getElementById('baslik').value, kategori = document.getElementById('kategori').value,
                  tarih = document.getElementById('tarih').value, toplamMiktar = parseFloat(document.getElementById('miktar').value),
                  odemeTuru = odemeTuruSelect.value, aciklama = document.getElementById('aciklama').value,
                  dolarKuru = parseFloat(document.getElementById('dolarKuruInput').value.replace(',', '.'));
            
            let odemeler = getOdemeler();

            if (odemeTuru === 'nakit') {
                const ortakAlanlar = { kategori, aciklama, odendi: true, odemeKuru: isNaN(dolarKuru) || dolarKuru <= 0 ? null : dolarKuru };
                odemeler.push({ id: Date.now(), baslik, vadeTarihi: tarih, tutar: toplamMiktar, ...ortakAlanlar });
            } else {
                 const ortakAlanlar = { kategori, aciklama, odendi: false, odemeKuru: null };
                const taksitSayisi = parseInt(document.getElementById('taksitSayisi').value, 10);
                if (!taksitSayisi || taksitSayisi < 2) { 
                    alert('Lütfen geçerli bir taksit sayısı giriniz (en az 2).'); return;
                }
                const taksitTutari = toplamMiktar / taksitSayisi, groupID = Date.now();
                let vadeTarihi = new Date(tarih);
                for (let i = 1; i <= taksitSayisi; i++) {
                    odemeler.push({
                        id: groupID + i, groupID, parentBaslik: baslik,
                        baslik: `${baslik} (${i}/${taksitSayisi})`,
                        vadeTarihi: vadeTarihi.toISOString().split('T')[0],
                        tutar: taksitTutari, ...ortakAlanlar,
                    });
                    vadeTarihi.setMonth(vadeTarihi.getMonth() + 1);
                }
            }
            saveOdemeler(odemeler);
            odemeFormu.reset(); showPage('ana');
        };

        const markPaymentAsPaid = (id) => {
            const kurInput = document.querySelector(`input[data-kur-id='${id}']`);
            kurInput.classList.remove('invalid');
            const kur = parseFloat(kurInput.value.replace(',', '.'));

            if(isNaN(kur) || kur <= 0) {
                kurInput.classList.add('invalid');
                kurInput.focus();
                return;
            }

            let odemeler = getOdemeler();
            const odemeIndex = odemeler.findIndex(o => o.id === id);
            if (odemeIndex > -1) {
                odemeler[odemeIndex].odendi = true;
                odemeler[odemeIndex].odemeKuru = kur;
                saveOdemeler(odemeler);
                renderHomePage();
            }
        };
        
        const exportToCsv = () => {
            const odemeler = getOdemeler();
            if(odemeler.length === 0) {
                alert("Dışa aktarılacak veri bulunmuyor.");
                return;
            }
            const activeProject = getActiveProject();

            let toplamGenel = 0, odenenTutar = 0, bekleyenTutar = 0;
            odemeler.forEach(odeme => {
                toplamGenel += odeme.tutar;
                if (odeme.odendi) odenenTutar += odeme.tutar;
                else bekleyenTutar += odeme.tutar;
            });

            const DELIMITER = ';';
            const escapeCsv = (str) => {
                if (str === null || str === undefined) return '';
                str = String(str);
                if (str.includes(DELIMITER) || str.includes('"') || str.includes('\n')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            const formatNumber = (num) => String(num.toFixed(2)).replace('.', ',');

            let csvRows = [];
            
            csvRows.push(`PROJE RAPORU: ${escapeCsv(activeProject.name)}`);
            csvRows.push('');
            csvRows.push(`GENEL ÖZET${DELIMITER}`);
            csvRows.push(`Toplam Borç${DELIMITER}${formatNumber(toplamGenel)} ₺`);
            csvRows.push(`Ödenmiş Tutar${DELIMITER}${formatNumber(odenenTutar)} ₺`);
            csvRows.push(`Bekleyen Tutar${DELIMITER}${formatNumber(bekleyenTutar)} ₺`);
            csvRows.push(''); 
            csvRows.push('--- ÖDEME DETAYLARI ---');
            csvRows.push('');

            const headers = ["Kategori", "Başlık", "Açıklama", "Vade Tarihi", "Tutar (TRY)", "Durum", "Ödeme Kuru ($)"];
            csvRows.push(headers.join(DELIMITER));
            
            const sortedOdemeler = [...odemeler].sort((a,b) => (a.kategori || '').localeCompare(b.kategori || '') || new Date(a.vadeTarihi) - new Date(b.vadeTarihi));

            sortedOdemeler.forEach(odeme => {
                const row = [
                    escapeCsv(odeme.kategori),
                    escapeCsv(odeme.baslik),
                    escapeCsv(odeme.aciklama),
                    new Date(odeme.vadeTarihi).toLocaleDateString('tr-TR'),
                    formatNumber(odeme.tutar),
                    odeme.odendi ? "Ödendi" : "Bekliyor",
                    odeme.odemeKuru ? formatNumber(odeme.odemeKuru) : ''
                ].join(DELIMITER);
                csvRows.push(row);
            });

            const csvContent = "\uFEFF" + csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                const filename = `${activeProject.name.replace(/[\/\\?%*:|"<>]/g, '-')}_odemeler.csv`;
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        const backupData = () => {
            const appDataString = localStorage.getItem(APP_DATA_KEY);
            if (!appDataString) {
                alert("Yedeklenecek veri bulunmuyor.");
                return;
            }

            const blob = new Blob([appDataString], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                const filename = `finans_takip_yedek_${new Date().toISOString().split('T')[0]}.txt`;
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // Event Listeners
        yeniOdemeBtn.addEventListener('click', () => showPage('form'));
        iptalBtn.addEventListener('click', () => showPage('ana'));
        yeniKategoriBtn.addEventListener('click', addNewCategory);
        exportBtn.addEventListener('click', exportToCsv);
        backupBtn.addEventListener('click', backupData);
        
        kategoriFiltre.addEventListener('change', () => {
            currentView = 'all';
            renderHomePage();
        });
        
        gelecekOdemelerBtn.addEventListener('click', () => {
            currentView = currentView === 'future' ? 'all' : 'future';
            kategoriFiltre.value = 'Tümü';
            renderHomePage();
        });

        odemeTuruSelect.addEventListener('change', () => {
            const isVadeli = odemeTuruSelect.value === 'vadeli';
            taksitAlani.classList.toggle('hidden', !isVadeli);
            dolarKuruAlani.classList.toggle('hidden', isVadeli);
            document.getElementById('taksitSayisi').required = isVadeli;
        });

        odemeFormu.addEventListener('submit', handleFormSubmit);

        odemeTablosuBody.addEventListener('click', e => {
            const target = e.target;
            if (target.matches('[data-delete-id]')) {
                saveOdemeler(getOdemeler().filter(o => o.id !== parseInt(target.dataset.deleteId, 10)));
                renderHomePage();
            } else if (target.matches('[data-delete-group]')) {
                saveOdemeler(getOdemeler().filter(o => o.groupID !== parseInt(target.dataset.deleteGroup, 10)));
                renderHomePage();
            } else if (target.matches('[data-mark-paid-id]')) {
                markPaymentAsPaid(parseInt(target.dataset.markPaidId, 10));
            } else {
                const parentRow = target.closest('.collapsible');
                if (parentRow) {
                    parentRow.classList.toggle('open');
                    const groupID = parentRow.dataset.groupId;
                    document.querySelectorAll(`.installment-row[data-group-id='${groupID}']`).forEach(row => {
                        row.classList.toggle('show');
                    });
                }
            }
        });
        
        projectSelector.addEventListener('change', (e) => {
            const projectId = parseInt(e.target.value, 10);
            let appData = getAppData();
            appData.activeProjectId = projectId;
            saveAppData(appData);
            renderAll();
        });

        addProjectBtn.addEventListener('click', () => {
             const projectName = prompt("Yeni inşaat projesinin adını giriniz:");
            if (projectName && projectName.trim() !== '') {
                const appData = getAppData();
                const newProject = { 
                    id: Date.now(), 
                    name: projectName.trim(),
                    payments: [],
                    categories: ['Genel Gider']
                };
                appData.projects.push(newProject);
                appData.activeProjectId = newProject.id;
                saveAppData(appData);
                renderAll();
            }
        });

        deleteProjectBtn.addEventListener('click', () => {
            const appData = getAppData();
            if (appData.projects.length <= 1) {
                alert("Son projeyi silemezsiniz!");
                return;
            }
            const projectId = getActiveProject().id;
            if (confirm("Bu projeyi ve tüm verilerini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.")) {
                appData.projects = appData.projects.filter(p => p.id !== projectId);
                appData.activeProjectId = appData.projects[0]?.id || null;
                saveAppData(appData);
                renderAll();
            }
        });

        renderAll();
    });
    </script>
</body>
</html>
